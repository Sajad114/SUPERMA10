<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المتجر المتميزة</title>
    <style>
        /* إعدادات أساسية متطورة */
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap');
        
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --light-color: rgba(255, 255, 255, 0.8);
            --dark-color: #1a1a2e;
            --glass-blur: 12px;
            --glass-opacity: 0.25;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Tajawal', sans-serif;
            direction: rtl;
            background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            color: var(--dark-color);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* تأثير الزجاج الشفاف */
        .glass {
            background: rgba(255, 255, 255, var(--glass-opacity));
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        /* الحاوية الرئيسية */
        .container {
            width: 95%;
            max-width: 1200px;
            padding: 30px;
            margin: 20px 0;
            transition: all 0.4s ease;
        }
        
        /* العناوين المتميزة */
        h1, h2, h3 {
            color: white;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            font-weight: 700;
        }
        
        h1 {
            font-size: 2.5rem;
            background: linear-gradient(to right, #fff, #c9d6ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* إدخال البيانات المطور */
        input, textarea, select, button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 12px;
            outline: none;
            font-size: 16px;
            font-family: 'Tajawal', sans-serif;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.7);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        input:focus, textarea:focus, select:focus {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }
        
        /* الأزرار المتميزة */
        button {
            background: var(--primary-color);
            color: white;
            font-weight: bold;
            cursor: pointer;
            letter-spacing: 1px;
            text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.6);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        button::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: translateX(-100%);
            transition: 0.6s;
        }
        
        button:hover::after {
            transform: translateX(100%);
        }
        
        .btn-success {
            background: var(--success-color);
            box-shadow: 0 4px 15px rgba(76, 201, 240, 0.4);
        }
        
        .btn-danger {
            background: var(--danger-color);
            box-shadow: 0 4px 15px rgba(247, 37, 133, 0.4);
        }
        
        .btn-warning {
            background: var(--warning-color);
            box-shadow: 0 4px 15px rgba(248, 150, 30, 0.4);
        }
        
        /* شريط التحميل المتميز */
        #progressBarContainer {
            width: 100%;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            margin: 20px 0;
            display: none;
            overflow: hidden;
            height: 15px;
        }
        
        #progressBar {
            width: 0%;
            height: 100%;
            border-radius: 12px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            transition: width 0.4s ease;
            position: relative;
        }
        
        #progressBar::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: progressShine 2s infinite;
        }
        
        @keyframes progressShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* رسالة الإشعار المتميزة */
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeIn 0.5s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .alert-success {
            background: rgba(76, 201, 240, 0.8);
        }
        
        .alert-danger {
            background: rgba(247, 37, 133, 0.8);
        }
        
        .alert-warning {
            background: rgba(248, 150, 30, 0.8);
        }
        
        .closebtn {
            cursor: pointer;
            font-size: 22px;
            font-weight: bold;
            transition: 0.3s;
        }
        
        .closebtn:hover {
            transform: scale(1.3);
        }
        
        /* تنسيق الجدول المتميز */
        .dataTables_wrapper {
            width: 100%;
            margin: 20px 0;
        }
        
        table.dataTable {
            width: 100% !important;
            margin: 15px 0 !important;
            border-collapse: separate;
            border-spacing: 0 10px;
        }
        
        table.dataTable thead th {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            padding: 15px;
            border: none;
            font-weight: 700;
        }
        
        table.dataTable tbody tr {
            background: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
            border-radius: 12px;
            overflow: hidden;
        }
        
        table.dataTable tbody tr:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        table.dataTable tbody td {
            padding: 15px;
            border: none;
            vertical-align: middle;
        }
        
        table.dataTable tbody td:first-child {
            border-top-right-radius: 12px;
            border-bottom-right-radius: 12px;
        }
        
        table.dataTable tbody td:last-child {
            border-top-left-radius: 12px;
            border-bottom-left-radius: 12px;
        }
        
        /* تنسيق الصور في الجدول */
        .product-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .product-img:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* تنسيق الأزرار في الجدول */
        .action-btn {
            padding: 8px 15px;
            margin: 0 5px;
            border-radius: 8px;
            font-size: 14px;
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .edit-btn {
            background: var(--success-color);
        }
        
        .delete-btn {
            background: var(--danger-color);
        }
        
        .view-btn {
            background: var(--primary-color);
        }
        
        /* تنسيق بطاقة المنتج */
        .product-card {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.4s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.9);
        }
        
        .product-card img {
            width: 100%;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .product-card h3 {
            color: var(--dark-color);
            margin-bottom: 10px;
            font-size: 1.3rem;
        }
        
        .product-card .price {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.2rem;
            margin: 10px 0;
        }
        
        /* تنسيق علامات التبويب */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 5px;
        }
        
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border-radius: 8px;
            margin: 0 5px;
            font-weight: bold;
            color: white;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: rgba(255, 255, 255, 0.7);
            color: var(--dark-color);
        }
        
        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        /* تنسيق لوحة الإحصائيات */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }
        
        .stat-card h3 {
            color: var(--dark-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        .stat-card .change {
            font-size: 0.9rem;
            padding: 3px 10px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .change.positive {
            background: rgba(76, 201, 240, 0.2);
            color: var(--success-color);
        }
        
        .change.negative {
            background: rgba(247, 37, 133, 0.2);
            color: var(--danger-color);
        }
        
        /* تنسيق النموذج */
        .form-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        /* تنسيق معاينة الصور */
        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .preview-item .remove-img {
            position: absolute;
            top: 5px;
            left: 5px;
            background: var(--danger-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .preview-item:hover .remove-img {
            opacity: 1;
        }
        
        /* تأثيرات متطورة */
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(67, 97, 238, 0); }
            100% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0); }
        }
        
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        /* تحسين التجاوب للأجهزة الصغيرة */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                width: 100%;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                margin: 5px;
                flex: 1;
                text-align: center;
            }
            
            table.dataTable thead th {
                padding: 10px 5px;
                font-size: 14px;
            }
            
            table.dataTable tbody td {
                padding: 10px 5px;
                font-size: 14px;
            }
            
            .action-btn {
                padding: 5px 8px;
                margin: 2px;
                font-size: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .form-container {
                grid-template-columns: 1fr;
            }
            
            input, textarea, select, button {
                padding: 12px;
            }
        }
    </style>
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container glass">
        <!-- شاشة تسجيل الدخول -->
        <div class="login-form" id="loginForm">
            <div class="glass" style="padding: 40px; max-width: 500px; margin: 0 auto;">
                <h1 class="text-center">مرحباً بك</h1>
                <p class="text-center" style="color: white; margin-bottom: 30px;">سجل الدخول لإدارة متجرك</p>
                
                <div class="form-group">
                    <label for="username">اسم المستخدم:</label>
                    <input type="text" id="username" placeholder="أدخل اسم المستخدم">
                </div>
                
                <div class="form-group">
                    <label for="password">كلمة المرور:</label>
                    <input type="password" id="password" placeholder="أدخل كلمة المرور">
                </div>
                
                <div class="form-group">
                    <button id="loginButton" class="pulse">
                        <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
                    </button>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <a href="#" style="color: white; text-decoration: none;">نسيت كلمة المرور؟</a>
                </div>
            </div>
        </div>
        
        <!-- لوحة التحكم -->
        <div class="admin-panel" id="adminPanel" style="display: none;">
            <!-- شريط العنوان -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h1>
                    <i class="fas fa-store"></i> لوحة تحكم المتجر
                </h1>
                <button id="logoutButton" class="btn-danger">
                    <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                </button>
            </div>
            
            <!-- إحصائيات سريعة -->
            <div class="stats-container">
                <div class="stat-card glass">
                    <h3>إجمالي المنتجات</h3>
                    <div class="value" id="totalProducts">0</div>
                    <div class="change positive">
                        <i class="fas fa-arrow-up"></i> 12% عن الشهر الماضي
                    </div>
                </div>
                
                <div class="stat-card glass">
                    <h3>المبيعات اليوم</h3>
                    <div class="value" id="todaySales">0</div>
                    <div class="change positive">
                        <i class="fas fa-arrow-up"></i> 8% عن الأمس
                    </div>
                </div>
                
                <div class="stat-card glass">
                    <h3>العملاء الجدد</h3>
                    <div class="value" id="newCustomers">0</div>
                    <div class="change negative">
                        <i class="fas fa-arrow-down"></i> 5% عن الأسبوع الماضي
                    </div>
                </div>
                
                <div class="stat-card glass">
                    <h3>الإيرادات الشهرية</h3>
                    <div class="value" id="monthlyRevenue">0</div>
                    <div class="change positive">
                        <i class="fas fa-arrow-up"></i> 22% عن الشهر الماضي
                    </div>
                </div>
            </div>
            
            <!-- علامات التبويب -->
            <div class="tabs">
                <div class="tab active" data-tab="products">المنتجات</div>
                <div class="tab" data-tab="add-product">إضافة منتج</div>
                <div class="tab" data-tab="orders">الطلبات</div>
                <div class="tab" data-tab="customers">العملاء</div>
            </div>
            
            <!-- محتوى علامات التبويب -->
            <div class="tab-content active" id="products-tab">
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <div style="width: 300px;">
                        <input type="text" id="searchProduct" placeholder="ابحث عن المنتج...">
                    </div>
                    <button id="refreshProducts">
                        <i class="fas fa-sync-alt"></i> تحديث القائمة
                    </button>
                </div>
                
                <table class="product-table display" id="productTable" style="width:100%">
                    <thead>
                        <tr>
                            <th>صورة</th>
                            <th>اسم المنتج</th>
                            <th>السعر</th>
                            <th>الكمية</th>
                            <th>التصنيف</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- سيتم ملؤها بالبيانات -->
                    </tbody>
                </table>
            </div>
            
            <div class="tab-content" id="add-product-tab">
                <div class="form-container">
                    <div>
                        <div class="form-group">
                            <label for="coverImage">صورة الغلاف:</label>
                            <input type="file" id="coverImage" accept="image/*">
                            <div class="image-preview" id="coverPreview"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="productName">اسم المنتج:</label>
                            <input type="text" id="productName" placeholder="أدخل اسم المنتج">
                        </div>
                        
                        <div class="form-group">
                            <label for="productPrice">سعر المنتج:</label>
                            <input type="number" id="productPrice" placeholder="أدخل السعر">
                        </div>
                        
                        <div class="form-group">
                            <label for="productQuantity">الكمية المتاحة:</label>
                            <input type="number" id="productQuantity" placeholder="أدخل الكمية">
                        </div>
                    </div>
                    
                    <div>
                        <div class="form-group">
                            <label for="productCategory">التصنيف:</label>
                            <select id="productCategory">
                                <option value="electronics">إلكترونيات</option>
                                <option value="clothing">ملابس</option>
                                <option value="home">أدوات منزلية</option>
                                <option value="beauty">الجمال والعناية</option>
                                <option value="sports">الرياضة</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="productDescription">وصف المنتج:</label>
                            <textarea id="productDescription" rows="4" placeholder="أدخل وصف المنتج"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="detailImages">صور التفاصيل (حتى 4 صور):</label>
                            <input type="file" id="detailImages" accept="image/*" multiple>
                            <div class="image-preview" id="detailsPreview"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="productVideo">فيديو المنتج (اختياري):</label>
                    <input type="file" id="productVideo" accept="video/*">
                    <div id="videoPreview" style="margin-top: 10px;"></div>
                </div>
                
                <div class="progress-bar-container" id="progressBarContainer">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                
                <div style="text-align: left;">
                    <button id="addProductButton" class="btn-success">
                        <i class="fas fa-plus-circle"></i> إضافة المنتج
                    </button>
                </div>
            </div>
            
            <div class="tab-content" id="orders-tab">
                <h2>إدارة الطلبات</h2>
                <p>هنا يمكنك عرض وإدارة طلبات العملاء</p>
                <!-- محتوى إدارة الطلبات -->
            </div>
            
            <div class="tab-content" id="customers-tab">
                <h2>إدارة العملاء</h2>
                <p>هنا يمكنك عرض وإدارة بيانات العملاء</p>
                <!-- محتوى إدارة العملاء -->
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables JS -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.js"></script>
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, get, child } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";
        import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

        // إعداد Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyADaBoLHAzuhsF_PffLp31hnkp0cmTK-18",
            authDomain: "supermax-c14fd.firebaseapp.com",
            databaseURL: "https://supermax-c14fd-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "supermax-c14fd",
            storageBucket: "supermax-c14fd.appspot.com",
            messagingSenderId: "872444131439",
            appId: "1:872444131439:web:f9369fe06b903b1599f59a",
            measurementId: "G-8DSQ5M49HE"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        // عناصر DOM
        const loginForm = document.getElementById('loginForm');
        const adminPanel = document.getElementById('adminPanel');
        const loginButton = document.getElementById('loginButton');
        const logoutButton = document.getElementById('logoutButton');
        const addProductButton = document.getElementById('addProductButton');
        const refreshProducts = document.getElementById('refreshProducts');
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        const coverPreview = document.getElementById('coverPreview');
        const detailsPreview = document.getElementById('detailsPreview');
        const videoPreview = document.getElementById('videoPreview');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // إحصائيات
        const totalProductsEl = document.getElementById('totalProducts');
        const todaySalesEl = document.getElementById('todaySales');
        const newCustomersEl = document.getElementById('newCustomers');
        const monthlyRevenueEl = document.getElementById('monthlyRevenue');

        // تسجيل الدخول
        loginButton.addEventListener('click', async () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showAlert('يرجى إدخال اسم المستخدم وكلمة المرور', 'danger');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, username, password);
                showAlert('تم تسجيل الدخول بنجاح', 'success');
                loginForm.style.display = 'none';
                adminPanel.style.display = 'block';
                loadProducts();
                loadStats();
            } catch (error) {
                console.error('خطأ في تسجيل الدخول:', error);
                showAlert('خطأ في تسجيل الدخول. يرجى التحقق من البيانات والمحاولة مرة أخرى.', 'danger');
            }
        });

        // تسجيل الخروج
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showAlert('تم تسجيل الخروج بنجاح', 'success');
                loginForm.style.display = 'block';
                adminPanel.style.display = 'none';
            } catch (error) {
                console.error('خطأ في تسجيل الخروج:', error);
                showAlert('حدث خطأ أثناء تسجيل الخروج', 'danger');
            }
        });

        // تبديل علامات التبويب
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });

        // معاينة الصور
        document.getElementById('coverImage').addEventListener('change', function(e) {
            coverPreview.innerHTML = '';
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    previewItem.innerHTML = `
                        <img src="${event.target.result}" alt="Cover Preview">
                        <div class="remove-img" onclick="removeCoverImage()">×</div>
                    `;
                    coverPreview.appendChild(previewItem);
                };
                
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('detailImages').addEventListener('change', function(e) {
            detailsPreview.innerHTML = '';
            if (e.target.files.length > 0) {
                const files = Array.from(e.target.files).slice(0, 4); // الحد الأقصى 4 صور
                
                files.forEach((file, index) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        const previewItem = document.createElement('div');
                        previewItem.className = 'preview-item';
                        previewItem.innerHTML = `
                            <img src="${event.target.result}" alt="Detail Preview ${index + 1}">
                            <div class="remove-img" onclick="removeDetailImage(${index})">×</div>
                        `;
                        detailsPreview.appendChild(previewItem);
                    };
                    
                    reader.readAsDataURL(file);
                });
            }
        });

        // معاينة الفيديو
        document.getElementById('productVideo').addEventListener('change', function(e) {
            videoPreview.innerHTML = '';
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const url = URL.createObjectURL(file);
                
                videoPreview.innerHTML = `
                    <video controls width="100%" style="border-radius: 10px; margin-top: 10px;">
                        <source src="${url}" type="${file.type}">
                        متصفحك لا يدعم تشغيل الفيديو.
                    </video>
                    <button onclick="removeVideo()" class="btn-danger" style="margin-top: 10px;">
                        <i class="fas fa-trash"></i> إزالة الفيديو
                    </button>
                `;
            }
        });

        // إضافة منتج
        addProductButton.addEventListener('click', async () => {
            const coverImage = document.getElementById('coverImage').files[0];
            const productName = document.getElementById('productName').value;
            const productPrice = document.getElementById('productPrice').value;
            const productQuantity = document.getElementById('productQuantity').value;
            const productCategory = document.getElementById('productCategory').value;
            const productDescription = document.getElementById('productDescription').value;
            const detailImages = document.getElementById('detailImages').files;
            const productVideo = document.getElementById('productVideo').files[0];

            // التحقق من الحقول المطلوبة
            if (!coverImage || !productName || !productPrice || !productQuantity || !productDescription || detailImages.length === 0) {
                showAlert('يرجى ملء جميع الحقول المطلوبة', 'danger');
                return;
            }

            progressBarContainer.style.display = 'block';
            progressBar.style.width = '0%';

            try {
                // رفع صورة الغلاف
                const coverImageRef = storageRef(storage, `products/${Date.now()}_${coverImage.name}`);
                await uploadBytes(coverImageRef, coverImage);
                const coverImageUrl = await getDownloadURL(coverImageRef);

                // رفع الصور التفصيلية
                const detailImageUrls = [];
                const detailUploads = Array.from(detailImages).slice(0, 4).map(async (image, index) => {
                    const detailImageRef = storageRef(storage, `products/${Date.now()}_${index}_${image.name}`);
                    await uploadBytes(detailImageRef, image);
                    const detailImageUrl = await getDownloadURL(detailImageRef);
                    detailImageUrls.push(detailImageUrl);
                    
                    // تحديث شريط التقدم
                    const progress = ((index + 1) / Math.min(detailImages.length, 4)) * 100;
                    progressBar.style.width = `${progress}%`;
                });

                await Promise.all(detailUploads);

                // رفع فيديو المنتج إذا تم تحميله
                let productVideoUrl = '';
                if (productVideo) {
                    const productVideoRef = storageRef(storage, `products/${Date.now()}_${productVideo.name}`);
                    await uploadBytes(productVideoRef, productVideo);
                    productVideoUrl = await getDownloadURL(productVideoRef);
                }

                // إضافة المنتج إلى قاعدة البيانات
                const productRef = push(ref(db, 'products'));
                await set(productRef, {
                    coverImage: coverImageUrl,
                    name: productName,
                    price: productPrice,
                    quantity: productQuantity,
                    category: productCategory,
                    description: productDescription,
                    detailImages: detailImageUrls,
                    video: productVideoUrl || null,
                    createdAt: new Date().toISOString(),
                    status: 'active'
                });

                showAlert('تمت إضافة المنتج بنجاح', 'success');
                resetForm();
                loadProducts();
                loadStats();
            } catch (error) {
                console.error("خطأ في إضافة المنتج:", error);
                showAlert('حدث خطأ أثناء إضافة المنتج. يرجى المحاولة مرة أخرى.', 'danger');
            } finally {
                progressBarContainer.style.display = 'none';
            }
        });

        // تحميل المنتجات
        function loadProducts() {
            const productTable = $('#productTable').DataTable({
                destroy: true,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.10.21/i18n/Arabic.json'
                },
                ajax: {
                    url: 'https://supermax-c14fd-default-rtdb.asia-southeast1.firebasedatabase.app/products.json',
                    dataSrc: function(json) {
                        if (!json) return [];
                        
                        const products = [];
                        Object.keys(json).forEach(key => {
                            products.push({
                                id: key,
                                ...json[key]
                            });
                        });
                        return products;
                    }
                },
                columns: [
                    { 
                        data: 'coverImage',
                        render: function(data) {
                            return `<img src="${data}" class="product-img" alt="Product Image">`;
                        }
                    },
                    { data: 'name' },
                    { 
                        data: 'price',
                        render: function(data) {
                            return `${data} ر.س`;
                        }
                    },
                    { data: 'quantity' },
                    { 
                        data: 'category',
                        render: function(data) {
                            const categories = {
                                'electronics': 'إلكترونيات',
                                'clothing': 'ملابس',
                                'home': 'أدوات منزلية',
                                'beauty': 'الجمال والعناية',
                                'sports': 'الرياضة'
                            };
                            return categories[data] || data;
                        }
                    },
                    { 
                        data: 'status',
                        render: function(data) {
                            return data === 'active' ? 
                                '<span style="color: green;"><i class="fas fa-check-circle"></i> نشط</span>' : 
                                '<span style="color: red;"><i class="fas fa-times-circle"></i> غير نشط</span>';
                        }
                    },
                    {
                        data: 'id',
                        render: function(data, type, row) {
                            return `
                                <button class="action-btn view-btn" onclick="viewProduct('${data}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn edit-btn" onclick="editProduct('${data}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete-btn" onclick="deleteProduct('${data}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;
                        }
                    }
                ]
            });

            // البحث عن المنتجات
            document.getElementById('searchProduct').addEventListener('input', function() {
                productTable.search(this.value).draw();
            });
        }

        // تحديث الإحصائيات
        async function loadStats() {
            try {
                const snapshot = await get(ref(db, 'products'));
                const products = snapshot.val();
                const totalProducts = products ? Object.keys(products).length : 0;
                
                totalProductsEl.textContent = totalProducts;
                todaySalesEl.textContent = Math.floor(Math.random() * 100); // بيانات وهمية للتوضيح
                newCustomersEl.textContent = Math.floor(Math.random() * 20); // بيانات وهمية للتوضيح
                monthlyRevenueEl.textContent = (Math.random() * 10000).toFixed(2); // بيانات وهمية للتوضيح
            } catch (error) {
                console.error('خطأ في تحميل الإحصائيات:', error);
            }
        }

        // عرض تنبيه
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                ${message}
                <span class="closebtn">&times;</span>
            `;
            
            document.querySelector('.container').prepend(alertDiv);
            
            const closeBtn = alertDiv.querySelector('.closebtn');
            closeBtn.addEventListener('click', () => {
                alertDiv.remove();
            });
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // إعادة تعيين النموذج
        function resetForm() {
            document.getElementById('productForm').reset();
            coverPreview.innerHTML = '';
            detailsPreview.innerHTML = '';
            videoPreview.innerHTML = '';
        }

        // تحديث قائمة المنتجات
        refreshProducts.addEventListener('click', () => {
            loadProducts();
            showAlert('تم تحديث قائمة المنتجات', 'success');
        });

        // التحقق من حالة المستخدم عند التحميل
        window.onload = () => {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    loginForm.style.display = 'none';
                    adminPanel.style.display = 'block';
                    loadProducts();
                    loadStats();
                } else {
                    loginForm.style.display = 'block';
                    adminPanel.style.display = 'none';
                }
            });
        };

        // تعيين الدوال للاستخدام العام
        window.removeCoverImage = function() {
            document.getElementById('coverImage').value = '';
            coverPreview.innerHTML = '';
        };
        
        window.removeDetailImage = function(index) {
            const files = Array.from(document.getElementById('detailImages').files);
            files.splice(index, 1);
            
            const dt = new DataTransfer();
            files.forEach(file => dt.items.add(file));
            document.getElementById('detailImages').files = dt.files;
            
            // إعادة عرض الصور المتبقية
            detailsPreview.innerHTML = '';
            files.forEach((file, i) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    previewItem.innerHTML = `
                        <img src="${event.target.result}" alt="Detail Preview ${i + 1}">
                        <div class="remove-img" onclick="removeDetailImage(${i})">×</div>
                    `;
                    detailsPreview.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            });
        };
        
        window.removeVideo = function() {
            document.getElementById('productVideo').value = '';
            videoPreview.innerHTML = '';
        };
        
        window.viewProduct = function(productId) {
            alert(`عرض تفاصيل المنتج: ${productId}`);
            // يمكنك هنا فتح نموذج عرض تفاصيل المنتج
        };
        
        window.editProduct = function(productId) {
            alert(`تعديل المنتج: ${productId}`);
            // يمكنك هنا فتح نموذج تعديل المنتج
        };
        
        window.deleteProduct = function(productId) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟ لا يمكن التراجع عن هذا الإجراء.')) {
                // حذف المنتج من قاعدة البيانات
                remove(ref(db, `products/${productId}`))
                    .then(() => {
                        showAlert('تم حذف المنتج بنجاح', 'success');
                        loadProducts();
                        loadStats();
                    })
                    .catch(error => {
                        console.error('خطأ في حذف المنتج:', error);
                        showAlert('حدث خطأ أثناء حذف المنتج', 'danger');
                    });
            }
        };
    </script>
</body>
</html>
